name: Markdown Link Check

on:
  workflow_call:
    inputs:
      soft-fail:
        description: 'Whether to continue on broken links'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  markdown-link-check:
    name: Check Markdown Links
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Get changed markdown files
        id: changed-files
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- '*.md' | tr '\n' ' ')
          else
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT HEAD~1 HEAD -- '*.md' | tr '\n' ' ')
          fi
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed markdown files: $CHANGED_FILES"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.changed-files.outputs.has_changes == 'true'
        run: npm ci

      - name: Create logs directory
        if: steps.changed-files.outputs.has_changes == 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path logs | Out-Null

      - name: Run markdown link check
        id: link-check
        if: steps.changed-files.outputs.has_changes == 'true'
        shell: pwsh
        run: |
          $changedFiles = "${{ steps.changed-files.outputs.files }}" -split '\s+' | Where-Object { $_ }
          & scripts/linting/Markdown-Link-Check.ps1 -Path $changedFiles
        continue-on-error: ${{ inputs.soft-fail }}

      - name: Skip notification
        if: steps.changed-files.outputs.has_changes != 'true'
        run: echo "No markdown files changed, skipping link check."

      - name: Upload markdown link check results
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.4.3
        with:
          name: markdown-link-check-results
          path: logs/markdown-link-check-results.json
          retention-days: 30

      - name: Check results and fail if needed
        if: steps.changed-files.outputs.has_changes == 'true' && !inputs.soft-fail && steps.link-check.outcome == 'failure'
        shell: pwsh
        run: |
          Write-Host "Markdown link check failed and soft-fail is false. Failing the job."
          exit 1
