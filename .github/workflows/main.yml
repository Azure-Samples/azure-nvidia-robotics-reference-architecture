name: CI

on:
  push:
    branches:
      - main

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

jobs:
  # Spell checking using cspell
  spell-check:
    name: Spell Check
    uses: ./.github/workflows/spell-check.yml
    permissions:
      contents: read

  # Markdown linting using markdownlint-cli2
  markdown-lint:
    name: Markdown Lint
    uses: ./.github/workflows/markdown-lint.yml
    permissions:
      contents: read

  # Markdown table formatting check
  table-format:
    name: Table Format
    uses: ./.github/workflows/table-format.yml
    permissions:
      contents: read

  # Frontmatter validation for markdown files
  frontmatter-validation:
    name: Frontmatter Validation
    uses: ./.github/workflows/frontmatter-validation.yml
    with:
      changed-files-only: false
    permissions:
      contents: read

  # PowerShell script analysis
  psscriptanalyzer:
    name: PSScriptAnalyzer
    uses: ./.github/workflows/ps-script-analyzer.yml
    with:
      changed-files-only: false
    permissions:
      contents: read

  # YAML/actionlint workflow linting
  yaml-lint:
    name: YAML Lint
    uses: ./.github/workflows/yaml-lint.yml
    with:
      changed-files-only: false
    permissions:
      contents: read

  # Link language locale check
  link-lang-check:
    name: Link Language Check
    uses: ./.github/workflows/link-lang-check.yml
    permissions:
      contents: read

  # Markdown link validation
  markdown-link-check:
    name: Markdown Link Check
    uses: ./.github/workflows/markdown-link-check.yml
    permissions:
      contents: read

  # SHA pinning compliance for GitHub Actions and dependencies
  dependency-pinning:
    name: Dependency Pinning
    uses: ./.github/workflows/dependency-pinning-scan.yml
    permissions:
      contents: read
      security-events: write

  # PowerShell Pester test execution
  pester-tests:
    name: Pester Tests
    uses: ./.github/workflows/pester-tests.yml
    with:
      changed-files-only: false
      code-coverage: true
    permissions:
      contents: read
      id-token: write

  # Python pytest test execution
  pytest-tests:
    name: Pytest Tests
    uses: ./.github/workflows/pytest-tests.yml
    permissions:
      contents: read

  # Python linting using ruff
  python-lint:
    name: Python Lint
    uses: ./.github/workflows/python-lint.yml
    permissions:
      contents: read

  # CodeQL security analysis
  codeql-analysis:
    name: CodeQL Analysis
    uses: ./.github/workflows/codeql-analysis.yml
    permissions:
      contents: read
      security-events: write
      actions: read

  # Automated release PR management via release-please
  release-please:
    needs:
      - spell-check
      - markdown-lint
      - table-format
      - frontmatter-validation
      - psscriptanalyzer
      - yaml-lint
      - link-lang-check
      - markdown-link-check
      - dependency-pinning
      - pester-tests
      - pytest-tests
      - python-lint
      - codeql-analysis
    name: Release Please
    runs-on: ubuntu-latest
    concurrency:
      group: release-please-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: read
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2.0.0
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38  # v4.4.0
        with:
          token: ${{ steps.app-token.outputs.token }}
          config-file: release-please-config.json
          manifest-file: release-please-manifest.json
          # On release commits, skip PR creation to prevent bogus PRs
          # from draft release lazy tag timing. Release commits have zero
          # unreleased changes so skipping loses nothing. The tag is
          # created in the next step, ensuring subsequent runs find it.
          skip-github-pull-request: ${{ github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore(main)') }}

      - name: Checkout release PR branch
        if: ${{ steps.release.outputs.prs_created == 'true' }}
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4.2.2
        with:
          ref: ${{ fromJSON(steps.release.outputs.pr).headBranchName }}
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false

      - name: Setup uv
        if: ${{ steps.release.outputs.prs_created == 'true' }}
        uses: astral-sh/setup-uv@5a095e7a2014a4212f075830d4f7277575a9d098  # v7.3.1

      - name: Regenerate uv.lock
        if: ${{ steps.release.outputs.prs_created == 'true' }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          uv lock
          if git diff --quiet -- uv.lock; then
            echo "uv.lock is already up to date"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add uv.lock
          git commit -m "chore: regenerate uv.lock"
          git push

      # Workaround: release-please with "draft": true uses lazy tag
      # creation. The git tag is not materialized until the release is
      # published. Without the tag, release-please cannot find the draft
      # on subsequent runs, breaking version anchoring and causing bogus
      # changelog entries. The skip-github-pull-request conditional above
      # prevents PR creation on release commits (zero unreleased changes),
      # and this step creates the tag so subsequent runs find the release.
      # Replace both workarounds with "force-tag-creation": true in
      # release-please-config.json once release-please-action ships a
      # version that includes googleapis/release-please#2627.
      - name: Create git tag for draft release
        if: ${{ steps.release.outputs.release_created == 'true' }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          $tag = '${{ steps.release.outputs.tag_name }}'
          $repo = '${{ github.repository }}'
          $null = gh api "/repos/$repo/git/refs/tags/$tag" --silent 2>&1
          if ($LASTEXITCODE -ne 0) {
            gh api "/repos/$repo/git/refs" `
              -f "ref=refs/tags/$tag" `
              -f "sha=${{ github.sha }}"
            Write-Output "Created git tag $tag -> ${{ github.sha }}"
          } else {
            Write-Output "Git tag $tag already exists"
          }

  # Promote draft release to published
  publish-release:
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    needs: [release-please]
    name: Publish Release
    runs-on: ubuntu-latest
    concurrency:
      group: release-please-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: read
      issues: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2.0.0
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - name: Publish draft release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: gh release edit $env:TAG_NAME --draft=false --repo $env:GITHUB_REPOSITORY

      - name: Close released milestone
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          $milestones = gh api --paginate "repos/$env:GITHUB_REPOSITORY/milestones?per_page=100&state=all" --jq '.[]' 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Output '::warning::API call failed while querying milestones for ${{ needs.release-please.outputs.tag_name }}'
            exit 0
          }

          $match = @($milestones | ConvertFrom-Json) | Where-Object { $_.title -eq $env:TAG_NAME }
          if (-not $match) {
            Write-Output "::warning::No milestone found matching $env:TAG_NAME"
            exit 0
          }

          $msNumber = $match.number
          $msState = $match.state

          if ($msState -eq 'closed') {
            Write-Output "Milestone $env:TAG_NAME (#$msNumber) already closed"
            exit 0
          }

          $detail = gh api "repos/$env:GITHUB_REPOSITORY/milestones/$msNumber" 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Output "::warning::API call failed while querying milestone details for $env:TAG_NAME (#$msNumber)"
            exit 0
          }
          $openIssues = ($detail | ConvertFrom-Json).open_issues

          if ($openIssues -gt 0) {
            Write-Output "::warning::Milestone $env:TAG_NAME has $openIssues open issue(s) â€” triage after closure"
          }

          $null = gh api "repos/$env:GITHUB_REPOSITORY/milestones/$msNumber" --method PATCH -f state=closed 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Output "::warning::Failed to close milestone $env:TAG_NAME (#$msNumber)"
            exit 0
          }

          Write-Output "Closed milestone $env:TAG_NAME (#$msNumber)"
