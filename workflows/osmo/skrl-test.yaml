workflow:
  name: skrl-test
  timeout:
    exec_timeout: 1h
  resources:
    default:
      gpu: 1
      cpu: 120
      memory: 480Gi
      storage: 200Gi
  tasks:
    - name: skrl-training-test
      image: "{{ image }}"
      command:
        - /bin/bash
        - /tmp/entry.sh
      environment:
        NVIDIA_DRIVER_CAPABILITIES: "all"
        TASK: "{{ task }}"
        NUM_ENVS: "{{ num_envs }}"
        MAX_ITERATIONS: "{{ max_iterations }}"
        ACCEPT_EULA: "Y"
        PRIVACY_CONSENT: "Y"
        TRAINING_ROOT: "{{input:0}}/{{ dataset_name }}/training"
        PYTHON: "{{ python }}"
      inputs:
        - dataset:
            name: "{{ dataset_bucket }}/{{ dataset_name }}"
            localpath: "{{ training_localpath }}"
      files:
        - path: /tmp/entry.sh
          contents: |
            #!/bin/bash
            set -euo pipefail

            TRAINING_ROOT="${TRAINING_ROOT:-{{input:0}}/training-code/training}"

            if [[ ! -d "${TRAINING_ROOT}" ]]; then
              echo "Error: Training root not found at ${TRAINING_ROOT}" >&2
              ls -la "{{input:0}}/" || true
              exit 1
            fi

            echo "=== SKRL Training Test ==="
            echo "Training root: ${TRAINING_ROOT}"
            echo "Task: ${TASK}"
            echo "Num envs: ${NUM_ENVS}"
            echo "Max iterations: ${MAX_ITERATIONS}"

            SRC_DIR="$(dirname "${TRAINING_ROOT}")"
            export PYTHONPATH="${SRC_DIR}:${PYTHONPATH:-}"

            # Resolve Python interpreter (same as train.sh)
            declare -a python_cmd
            if [[ -n "${PYTHON:-}" ]]; then
              IFS=' ' read -r -a python_cmd <<< "${PYTHON}"
            else
              python_cmd=(python)
            fi

            echo "Python cmd: ${python_cmd[*]}"
            echo "PYTHONPATH: ${PYTHONPATH}"

            echo "=== Launching skrl_training_test.py ==="
            exec "${python_cmd[@]}" -m training.scripts.skrl_training_test \
              --task "${TASK}" \
              --num_envs "${NUM_ENVS}" \
              --max_iterations "${MAX_ITERATIONS}" \
              --headless

default-values:
  image: nvcr.io/nvidia/isaac-lab:2.3.2
  task: Isaac-Velocity-Rough-Anymal-C-v0
  num_envs: "16"
  max_iterations: "5"
  python: "/workspace/isaaclab/isaaclab.sh -p"
  dataset_bucket: training
  dataset_name: training-code
  training_localpath: ""
