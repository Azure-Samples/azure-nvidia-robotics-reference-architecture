workflow:
  name: isaaclab-inline-training
  timeout:
    exec_timeout: 23h
  resources:
    default:
      gpu: 1
      cpu: 8
      memory: 48Gi
      storage: 80Gi
  tasks:
    - name: isaac-training
      image: "{{ image }}"
      command:
        - /bin/bash
        - /tmp/entry.sh
      environment:
        TASK: "{{ task }}"
        NUM_ENVS: "{{ num_envs }}"
        MAX_ITERATIONS: "{{ max_iterations }}"
        ACCEPT_EULA: "Y"
        PRIVACY_CONSENT: "Y"
        ENCODED_ARCHIVE: "{{ encoded_archive }}"
        PAYLOAD_ROOT: "{{ payload_root }}"
        AZURE_CLIENT_ID: "{{ azure_client_id }}"
        AZURE_TENANT_ID: "{{ azure_tenant_id }}"
        AZURE_SUBSCRIPTION_ID: "{{ azure_subscription_id }}"
        AZURE_RESOURCE_GROUP: "{{ azure_resource_group }}"
        AZUREML_WORKSPACE_NAME: "{{ azure_workspace_name }}"
        AZURE_AUTHORITY_HOST: "{{ azure_authority_host }}"
        AZURE_FEDERATED_TOKEN_FILE: "{{ azure_federated_token_file }}"
        MLFLOW_TRACKING_TOKEN_REFRESH_RETRIES: "{{ mlflow_token_refresh_retries }}"
        MLFLOW_HTTP_REQUEST_TIMEOUT: "{{ mlflow_http_request_timeout }}"
        RUN_AZURE_SMOKE_TEST: "{{ run_azure_smoke_test }}"
      files:
        - path: /tmp/entry.sh
          contents: |
            #!/bin/bash
            set -euo pipefail

            if [[ -z "${ENCODED_ARCHIVE:-}" ]]; then
              echo "encoded_archive is required" >&2
              exit 1
            fi

            ARCHIVE_PATH="${TEMP_ARCHIVE:-/tmp/isaac_payload.zip}"
            PAYLOAD_ROOT="${PAYLOAD_ROOT:-/workspace/isaac_payload}"
            TRAINING_ROOT="${TRAINING_ROOT:-${PAYLOAD_ROOT}/src/training}"

            mkdir -p "${PAYLOAD_ROOT}"
            trap 'rm -f "${ARCHIVE_PATH}"' EXIT

            printf '%s' "${ENCODED_ARCHIVE}" | base64 -d > "${ARCHIVE_PATH}"
            unzip -oq "${ARCHIVE_PATH}" -d "${PAYLOAD_ROOT}"

            export PYTHONPATH="${TRAINING_ROOT}:${PYTHONPATH:-}"

            bash "${TRAINING_ROOT}/scripts/train.sh" \
              --task "${TASK}" \
              --num_envs "${NUM_ENVS:-2048}" \
              --headless \
              ${MAX_ITERATIONS:+--max_iterations "${MAX_ITERATIONS}"}

default-values:
  image: nvcr.io/nvidia/isaac-lab:2.2.0
  task: Isaac-Velocity-Rough-Anymal-C-v0
  num_envs: "2048"
  max_iterations: ""
  encoded_archive: ""
  payload_root: /workspace/isaac_payload
  azure_client_id: ""
  azure_tenant_id: ""
  azure_subscription_id: ""
  azure_resource_group: ""
  azure_workspace_name: ""
  azure_authority_host: https://login.microsoftonline.com
  azure_federated_token_file: /var/run/secrets/azure/tokens/azure-identity-token
  mlflow_token_refresh_retries: "3"
  mlflow_http_request_timeout: "60"
  run_azure_smoke_test: "0"
