workflow:
  name: isaaclab-inline-training
  timeout:
    exec_timeout: 23h
  resources:
    default:
      gpu: 1
      cpu: 8
      memory: 48Gi
      storage: 80Gi
  tasks:
    - name: isaac-training
      image: "{{ image }}"
      command:
        - /bin/bash
        - /tmp/entry.sh
      environment:
        TASK: "{{ task }}"
        NUM_ENVS: "{{ num_envs }}"
        MAX_ITERATIONS: "{{ max_iterations }}"
        ACCEPT_EULA: "Y"
        PRIVACY_CONSENT: "Y"
        ENCODED_ARCHIVE: "{{ encoded_archive }}"
        PAYLOAD_ROOT: "{{ payload_root }}"
        SLEEP_AFTER_UNPACK: "{{ sleep_after_unpack }}"
        AZURE_CLIENT_ID: "{{ azure_client_id }}"
        AZURE_TENANT_ID: "{{ azure_tenant_id }}"
        AZURE_SUBSCRIPTION_ID: "{{ azure_subscription_id }}"
        AZURE_RESOURCE_GROUP: "{{ azure_resource_group }}"
        AZUREML_WORKSPACE_NAME: "{{ azure_workspace_name }}"
        AZURE_AUTHORITY_HOST: "{{ azure_authority_host }}"
        AZURE_FEDERATED_TOKEN_FILE: "{{ azure_federated_token_file }}"
        MLFLOW_TRACKING_TOKEN_REFRESH_RETRIES: "{{ mlflow_token_refresh_retries }}"
        MLFLOW_HTTP_REQUEST_TIMEOUT: "{{ mlflow_http_request_timeout }}"
        RUN_AZURE_SMOKE_TEST: "{{ run_azure_smoke_test }}"
        PYTHON: "{{ python }}"
        CHECKPOINT_URI: "{{ checkpoint_uri }}"
        CHECKPOINT_MODE: "{{ checkpoint_mode }}"
        REGISTER_CHECKPOINT: "{{ register_checkpoint }}"
      files:
        - path: /tmp/entry.sh
          contents: |
            {% raw %}
            #!/bin/bash
            set -euo pipefail

            if [[ -z "${ENCODED_ARCHIVE:-}" ]]; then
              echo "encoded_archive is required" >&2
              exit 1
            fi

            ARCHIVE_PATH="${TEMP_ARCHIVE:-/tmp/isaac_payload.zip}"
            PAYLOAD_ROOT="${PAYLOAD_ROOT:-/workspace/isaac_payload}"
            TRAINING_ROOT="${TRAINING_ROOT:-${PAYLOAD_ROOT}/src/training}"

            mkdir -p "${PAYLOAD_ROOT}"
            trap 'rm -f "${ARCHIVE_PATH}"' EXIT

            stream_kit_logs() {
              local kit_root="${KIT_LOG_ROOT:-/isaac-sim/kit/logs/Kit/Isaac-Sim/5.0}"
              echo "Collecting Kit logs from ${kit_root}"
              if [[ ! -d "${kit_root}" ]]; then
                echo "Kit log directory not found: ${kit_root}" >&2
                return 0
              fi

              local found=0
              while IFS= read -r log_path; do
                found=1
                echo "===== Omniverse Kit log: ${log_path} ====="
                if ! tail -n +1 "${log_path}"; then
                  echo "Warning: unable to read ${log_path}" >&2
                fi
              done < <(find "${kit_root}" -type f -name '*.log' -print 2>/dev/null | sort)

              if (( found == 0 )); then
                echo "No Kit log files discovered under ${kit_root}" >&2
              fi
            }

            printf '%s' "${ENCODED_ARCHIVE}" | base64 -d > "${ARCHIVE_PATH}"
            unzip -oq "${ARCHIVE_PATH}" -d "${PAYLOAD_ROOT}"

            if [[ -n "${SLEEP_AFTER_UNPACK:-}" ]]; then
              echo "SLEEP_AFTER_UNPACK set; sleeping for ${SLEEP_AFTER_UNPACK} after payload unpack"
              sleep "${SLEEP_AFTER_UNPACK}"
              echo "Finished post-unpack sleep; exiting"
              exit 0
            fi

            export PYTHONPATH="${TRAINING_ROOT}:${PYTHONPATH:-}"

            MODE="train"
            if [[ "${RUN_AZURE_SMOKE_TEST:-0}" == "1" ]]; then
              MODE="smoke-test"
            fi

            train_args=(
              --mode "${MODE}"
              --task "${TASK:-}"
              --num_envs "${NUM_ENVS:-}"
              --max_iterations "${MAX_ITERATIONS:-}"
              --checkpoint-uri "${CHECKPOINT_URI:-}"
              --checkpoint-mode "${CHECKPOINT_MODE:-from-scratch}"
              --register-checkpoint "${REGISTER_CHECKPOINT:-}"
              --headless
            )

            set +e
            bash "${TRAINING_ROOT}/scripts/train.sh" "${train_args[@]}"
            train_status=$?
            set -e

            stream_kit_logs || true

            if (( train_status != 0 )); then
              echo "Training exited with status ${train_status}" >&2
            else
              echo "Training completed successfully"
            fi

            exit "${train_status}"
            {% endraw %}

default-values:
  image: nvcr.io/nvidia/isaac-lab:2.2.0
  task: Isaac-Velocity-Rough-Anymal-C-v0
  num_envs: "2048"
  max_iterations: ""
  encoded_archive: ""
  payload_root: /workspace/isaac_payload
  sleep_after_unpack: ""
  azure_client_id: ""
  azure_tenant_id: ""
  azure_subscription_id: ""
  azure_resource_group: ""
  azure_workspace_name: ""
  azure_authority_host: https://login.microsoftonline.com
  azure_federated_token_file: /var/run/secrets/azure/tokens/azure-identity-token
  mlflow_token_refresh_retries: "3"
  mlflow_http_request_timeout: "60"
  python: "/workspace/isaaclab/isaaclab.sh -p"
  run_azure_smoke_test: "0"
  checkpoint_uri: ""
  checkpoint_mode: "from-scratch"
  register_checkpoint: ""
