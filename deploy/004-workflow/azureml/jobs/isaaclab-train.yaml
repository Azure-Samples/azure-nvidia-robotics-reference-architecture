$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json
name: isaaclab-train
display_name: IsaacLab Training
description: IsaacLab SKRL training job aligned with MLflow and checkpoint workflows.
experiment_name: isaaclab-training
code: azureml:isaaclab-training-code@latest
environment: azureml:isaaclab-training-env@latest
compute: azureml:isaaclab-training-cluster
identity:
  type: SystemAssigned
inputs:
  mode:
    type: literal
    value: train
  task:
    type: literal
    value: ""
  num_envs:
    type: literal
    value: ""
  max_iterations:
    type: literal
    value: ""
  checkpoint_uri:
    type: literal
    value: ""
  checkpoint_mode:
    type: literal
    value: from-scratch
  register_checkpoint:
    type: literal
    value: ""
  run_azure_smoke_test:
    type: literal
    value: "0"
  headless_flag:
    type: literal
    value: "--headless"
  subscription_id:
    type: literal
    value: ""
  resource_group:
    type: literal
    value: ""
  workspace_name:
    type: literal
    value: ""
  client_id:
    type: literal
    value: ""
  tenant_id:
    type: literal
    value: ""
  authority_host:
    type: literal
    value: https://login.microsoftonline.com
  federated_token_file:
    type: literal
    value: /var/run/secrets/azure/tokens/azure-identity-token
  mlflow_token_refresh_retries:
    type: literal
    value: "3"
  mlflow_http_request_timeout:
    type: literal
    value: "60"
command: >-
  bash src/training/scripts/train.sh
  --mode ${{inputs.mode}}
  {{if inputs.task}} --task ${{inputs.task}} {{endif}}
  {{if inputs.num_envs}} --num_envs ${{inputs.num_envs}} {{endif}}
  {{if inputs.max_iterations}} --max_iterations ${{inputs.max_iterations}} {{endif}}
  {{if inputs.checkpoint_uri}} --checkpoint-uri ${{inputs.checkpoint_uri}} {{endif}}
  {{if inputs.checkpoint_mode}} --checkpoint-mode ${{inputs.checkpoint_mode}} {{endif}}
  {{if inputs.register_checkpoint}} --register-checkpoint ${{inputs.register_checkpoint}} {{endif}}
  ${{inputs.headless_flag}}
environment_variables:
  AZURE_SUBSCRIPTION_ID: ${{inputs.subscription_id}}
  AZURE_RESOURCE_GROUP: ${{inputs.resource_group}}
  AZUREML_WORKSPACE_NAME: ${{inputs.workspace_name}}
  AZURE_CLIENT_ID: ${{inputs.client_id}}
  AZURE_TENANT_ID: ${{inputs.tenant_id}}
  AZURE_AUTHORITY_HOST: ${{inputs.authority_host}}
  AZURE_FEDERATED_TOKEN_FILE: ${{inputs.federated_token_file}}
  RUN_AZURE_SMOKE_TEST: ${{inputs.run_azure_smoke_test}}
  MLFLOW_TRACKING_TOKEN_REFRESH_RETRIES: ${{inputs.mlflow_token_refresh_retries}}
  MLFLOW_HTTP_REQUEST_TIMEOUT: ${{inputs.mlflow_http_request_timeout}}
  TRAINING_CHECKPOINT_OUTPUT: ${{outputs.checkpoints}}
outputs:
  checkpoints:
    type: uri_folder
    mode: upload
