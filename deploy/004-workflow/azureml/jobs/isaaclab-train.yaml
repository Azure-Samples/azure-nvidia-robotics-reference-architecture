$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json
name: isaaclab-train
display_name: IsaacLab Training
description: IsaacLab SKRL training job aligned with MLflow and checkpoint workflows.
experiment_name: isaaclab-training
code: azureml:isaaclab-training-code@latest
environment: azureml:isaaclab-training-env@latest
compute: azureml:isaaclab-training-cluster
identity:
  type: SystemAssigned
inputs:
  mode:
    type: literal
    value: train
  task:
    type: literal
    value: ""
  num_envs:
    type: literal
    value: ""
  max_iterations:
    type: literal
    value: ""
  checkpoint_uri:
    type: literal
    value: ""
  checkpoint_mode:
    type: literal
    value: from-scratch
  headless_flag:
    type: literal
    value: "--headless"
  subscription_id:
    type: string
  resource_group:
    type: string
  workspace_name:
    type: string
  register_checkpoint:
    type: string
    optional: true
  run_azure_smoke_test:
    type: boolean
    default: false
  mlflow_token_refresh_retries:
    type: integer
    default: 3
  mlflow_http_request_timeout:
    type: integer
    default: 60
command: >-
  bash src/training/scripts/train.sh
  {{if inputs.run_azure_smoke_test}}
  --mode smoke-test
  {{else}}
  --mode ${{inputs.mode}}
  {{endif}}
  {{if inputs.task}} --task ${{inputs.task}} {{endif}}
  {{if inputs.num_envs}} --num_envs ${{inputs.num_envs}} {{endif}}
  {{if inputs.max_iterations}} --max_iterations ${{inputs.max_iterations}} {{endif}}
  {{if inputs.checkpoint_uri}} --checkpoint-uri ${{inputs.checkpoint_uri}} {{endif}}
  {{if inputs.checkpoint_mode}} --checkpoint-mode ${{inputs.checkpoint_mode}} {{endif}}
  {{if inputs.register_checkpoint}} --register-checkpoint ${{inputs.register_checkpoint}} {{endif}}
  ${{inputs.headless_flag}}
environment_variables:
  TRAINING_CHECKPOINT_OUTPUT: ${{outputs.checkpoints}}
  AZURE_SUBSCRIPTION_ID: ${{inputs.subscription_id}}
  AZURE_RESOURCE_GROUP: ${{inputs.resource_group}}
  AZUREML_WORKSPACE_NAME: ${{inputs.workspace_name}}
  RUN_AZURE_SMOKE_TEST: ${{inputs.run_azure_smoke_test}}
  MLFLOW_TRACKING_TOKEN_REFRESH_RETRIES: ${{inputs.mlflow_token_refresh_retries}}
  MLFLOW_HTTP_REQUEST_TIMEOUT: ${{inputs.mlflow_http_request_timeout}}
outputs:
  checkpoints:
    type: uri_folder
    mode: upload
