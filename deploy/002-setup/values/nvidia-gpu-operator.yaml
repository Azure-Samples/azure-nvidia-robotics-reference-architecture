# NVIDIA GPU Operator Helm values for Azure AKS
# Configured for AKS with mixed GPU node pools:
#   - H100: datacenter driver managed by GPU Operator (driver.enabled: true)
#   - RTX PRO 6000: Microsoft GRID driver pre-installed on host via
#     gpu-grid-driver-installer DaemonSet (node label nvidia.com/gpu.deploy.driver=false
#     skips GPU Operator driver management on these nodes)

# Operator settings
operator:
  runtimeClass: nvidia

# Common tolerations for spot GPU nodes
# Applied to all GPU Operator components that need to run on GPU nodes
daemonsets:
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
    - key: kubernetes.azure.com/scalesetpriority
      operator: Equal
      value: spot
      effect: NoSchedule

# Driver managed by GPU Operator for datacenter GPUs (H100).
# RTX PRO 6000 nodes have nvidia.com/gpu.deploy.driver=false label set via
# Terraform node_labels, which causes the GPU Operator to skip driver deployment
# on those nodes. The Microsoft GRID driver (580.105.08-grid-azure) is installed
# separately via the gpu-grid-driver-installer DaemonSet (manifests/gpu-grid-driver-installer.yaml).
# kernelModuleType: proprietary required for Azure vGPU (RTX PRO 6000 BSE open modules unsupported)
driver:
  enabled: true
  kernelModuleType: proprietary
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
    - key: kubernetes.azure.com/scalesetpriority
      operator: Equal
      value: spot
      effect: NoSchedule

# Toolkit managed by GPU Operator (gpu_driver = "Skip" in Terraform)
toolkit:
  enabled: true
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
    - key: kubernetes.azure.com/scalesetpriority
      operator: Equal
      value: spot
      effect: NoSchedule

# Device plugin - required to advertise GPU resources to kubelet
devicePlugin:
  enabled: true
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
    - key: kubernetes.azure.com/scalesetpriority
      operator: Equal
      value: spot
      effect: NoSchedule

# Enable DCGM exporter for GPU metrics
dcgmExporter:
  enabled: true
  serviceMonitor:
    enabled: false  # Using PodMonitor instead
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
    - key: kubernetes.azure.com/scalesetpriority
      operator: Equal
      value: spot
      effect: NoSchedule

# Disable MIG (not used)
mig:
  strategy: single

# GPU Feature Discovery
gfd:
  enabled: true
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
    - key: kubernetes.azure.com/scalesetpriority
      operator: Equal
      value: spot
      effect: NoSchedule

# Node Feature Discovery - required to detect GPU nodes
node-feature-discovery:
  worker:
    tolerations:
      - key: node-role.kubernetes.io/master
        operator: Equal
        value: ""
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        operator: Equal
        value: ""
        effect: NoSchedule
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      - key: kubernetes.azure.com/scalesetpriority
        operator: Equal
        value: spot
        effect: NoSchedule

# Node labeller for GPU detection
nodeStatusExporter:
  enabled: true

# Validator ensures everything is working
validator:
  enabled: true
  tolerations:
    - key: nvidia.com/gpu
      operator: Exists
      effect: NoSchedule
    - key: kubernetes.azure.com/scalesetpriority
      operator: Equal
      value: spot
      effect: NoSchedule
