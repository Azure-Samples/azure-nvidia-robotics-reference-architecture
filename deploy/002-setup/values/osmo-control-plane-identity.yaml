# Azure Workload Identity configuration for OSMO control plane services
# Use with: helm upgrade -f osmo-control-plane.yaml -f osmo-control-plane-identity.yaml ...
#
# Requires:
# - AKS cluster with OIDC issuer and workload identity enabled
# - Managed identity with federated credentials for OSMO ServiceAccounts
# - Storage Blob Data Contributor role assigned to the managed identity
# - Key Vault Secrets User role assigned to the managed identity
# - SecretProviderClass deployed to namespace (azure-keyvault-secrets)
#
# The client-id annotation is set dynamically via --set during helm upgrade.
# Pod labels enable the AKS workload identity mutating webhook to inject
# projected service account tokens and Azure environment variables.
#
# CSI volumes trigger secret sync from Azure Key Vault when pods start.

serviceAccount:
  annotations:
    # Client ID set via --set "serviceAccount.annotations.azure\.workload\.identity/client-id=..."
    azure.workload.identity/client-id: ""

services:
  service:
    extraPodLabels:
      azure.workload.identity/use: "true"
    extraVolumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: azure-keyvault-secrets
    extraVolumeMounts:
      - name: secrets-store-inline
        mountPath: /mnt/secrets-store
        readOnly: true

  worker:
    extraPodLabels:
      azure.workload.identity/use: "true"
    extraVolumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: azure-keyvault-secrets
    extraVolumeMounts:
      - name: secrets-store-inline
        mountPath: /mnt/secrets-store
        readOnly: true

  logger:
    extraPodLabels:
      azure.workload.identity/use: "true"
    extraVolumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: azure-keyvault-secrets
    extraVolumeMounts:
      - name: secrets-store-inline
        mountPath: /mnt/secrets-store
        readOnly: true

  agent:
    extraPodLabels:
      azure.workload.identity/use: "true"
    extraVolumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: azure-keyvault-secrets
    extraVolumeMounts:
      - name: secrets-store-inline
        mountPath: /mnt/secrets-store
        readOnly: true

  delayedJobMonitor:
    extraPodLabels:
      azure.workload.identity/use: "true"
    extraVolumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: azure-keyvault-secrets
    extraVolumeMounts:
      - name: secrets-store-inline
        mountPath: /mnt/secrets-store
        readOnly: true
