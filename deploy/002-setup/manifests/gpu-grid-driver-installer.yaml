---
# Microsoft GRID Driver DaemonSet for Azure RTX PRO 6000 (vGPU) nodes
#
# The RTX PRO 6000 BSE in Azure uses SR-IOV vGPU passthrough (PCI ID 10de:2bb5)
# which requires the Microsoft GRID driver (v19.x vGPU Unified Driver) instead
# of the standard NVIDIA datacenter driver bundled with the GPU Operator.
#
# This DaemonSet runs on every node labeled nvidia.com/gpu.deploy.driver=false.
# An init container installs the GRID driver on the host via nsenter. The main
# container then sleeps, keeping the pod Running so the DaemonSet controller
# ensures new nodes (from scale-up or reimage) also receive the driver.
#
# The GPU Operator's driver DaemonSet is skipped on these nodes via the label.
# After the GRID driver is installed, the GPU Operator's toolkit, device-plugin,
# and validator components detect the pre-installed driver and proceed normally.
#
# Usage: kubectl apply -f gpu-grid-driver-installer.yaml
# Monitor: kubectl logs -n gpu-operator -l app.kubernetes.io/name=gpu-grid-driver-installer -c installer
#
# Reference:
#   https://learn.microsoft.com/en-us/azure/virtual-machines/linux/n-series-driver-setup
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: gpu-grid-driver-installer
  namespace: gpu-operator
  labels:
    app.kubernetes.io/name: gpu-grid-driver-installer
    app.kubernetes.io/component: driver
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: gpu-grid-driver-installer
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gpu-grid-driver-installer
        app.kubernetes.io/component: driver
    spec:
      nodeSelector:
        nvidia.com/gpu.deploy.driver: "false"
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      hostPID: true
      hostNetwork: true
      initContainers:
        - name: installer
          image: ubuntu:22.04
          securityContext:
            privileged: true
          volumeMounts:
            - name: host-root
              mountPath: /host
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -euo pipefail
              cat > /host/tmp/install-grid-driver.sh << 'SCRIPT'
              #!/bin/bash
              set -euo pipefail
              DRIVER_URL="https://download.microsoft.com/download/85beffdc-8361-4df4-a823-dcb1b230a7aa/NVIDIA-Linux-x86_64-580.105.08-grid-azure.run"
              DRIVER_FILE="/tmp/NVIDIA-Linux-x86_64-580.105.08-grid-azure.run"

              echo "=== Microsoft GRID Driver Installer for Azure RTX PRO 6000 ==="
              echo "Kernel: $(uname -r)"

              if nvidia-smi 2>/dev/null; then
                echo "NVIDIA GRID driver already functional"
                nvidia-smi
                exit 0
              fi

              echo "Removing existing NVIDIA kernel modules..."
              rmmod nvidia_uvm 2>/dev/null || true
              rmmod nvidia_modeset 2>/dev/null || true
              rmmod nvidia_drm 2>/dev/null || true
              rmmod nvidia_peermem 2>/dev/null || true
              rmmod nvidia 2>/dev/null || true

              echo "Installing build dependencies..."
              apt-get update -qq
              DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
                linux-headers-$(uname -r) build-essential wget 2>&1 | tail -5

              echo "Downloading Microsoft GRID driver..."
              wget -q -O "$DRIVER_FILE" "$DRIVER_URL"
              chmod +x "$DRIVER_FILE"

              echo "Installing GRID driver (compiling kernel modules)..."
              sh "$DRIVER_FILE" --silent --no-drm 2>&1 || {
                echo "Retrying with open kernel modules..."
                sh "$DRIVER_FILE" -M open --silent --no-drm 2>&1
              }

              echo "Loading NVIDIA kernel modules..."
              modprobe nvidia
              modprobe nvidia-uvm || true
              modprobe nvidia-modeset || true

              nvidia-persistenced --persistence-mode || true

              echo "=== Verification ==="
              nvidia-smi
              echo "=== GRID driver installation complete ==="
              SCRIPT

              chmod +x /host/tmp/install-grid-driver.sh
              echo "Running GRID driver installer on host via nsenter..."
              nsenter --target 1 --mount --uts --ipc --net --pid -- \
                /bin/bash /tmp/install-grid-driver.sh
      containers:
        - name: sleep
          image: registry.k8s.io/pause:3.10
      volumes:
        - name: host-root
          hostPath:
            path: /
